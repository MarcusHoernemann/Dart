<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#121212">
    
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    
    <title>DartLog</title>
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --bg: #121212;
            --card: #242424;
            --text: #ffffff;
            --accent: #007bff; 
            --accent-gradient: linear-gradient(135deg, #007bff 0%, #00c6ff 100%);
            --secondary-leg: #4caf50; 
            --secondary-win: #2e7d32; 
            --loss-leg: #b33a3a;     
            --loss-game: #c62828;    
            --ring-orange: #ff9800; 
            --pdf-btn-bg: #0056b3; 
            --delete-btn-bg: #8b0000;
            --undo-color: #ff9800;
            --input-bg: #1a1a1a;
            --muted-text: #888888;
            
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-serif: "Georgia", "Times New Roman", serif;
        }

        @media print {
            body { background: white !important; color: black !important; padding: 0; }
            .no-print { display: none !important; }
            .card { box-shadow: none; border: none; background: white; color: black; margin-bottom: 30px; }
            .archive-item content { display: block !important; }
            h2, h3 { color: black !important; border-bottom: 1px solid black; }
            table { color: black !important; border: 1px solid black; width: 100%; margin-bottom: 20px; }
            th, td { border-bottom: 1px solid #ccc; padding: 8px; }
            .app-footer { display: none; }
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .app-header {
            width: 100%;
            text-align: center;
            padding: 10px 0 15px 0;
        }

        .app-header h1 {
            margin: 0;
            font-family: var(--font-serif);
            font-size: 2.5rem;
            font-style: italic;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .container { width: 100%; max-width: 900px; flex: 1; }
        
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 1px solid #333;
        }

        .setup-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        @media (min-width: 600px) {
            .setup-container { grid-template-columns: 1fr 1fr; }
        }

        .player-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @media (min-width: 650px) or (orientation: landscape) {
            .player-row {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
            .player-info { min-width: 160px; }
            .grid-row { flex-grow: 1; }
        }

        .player-info { display: flex; justify-content: space-between; align-items: center; }
        
        h3 { 
            margin: 0; 
            font-size: 1.1rem; 
            font-family: var(--font-serif); 
            font-style: italic; 
        }
        
        .grid-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        
        button {
            border: none; color: white; padding: 12px 2px; border-radius: 6px;
            font-size: 9px; font-weight: 700; cursor: pointer; touch-action: manipulation; text-transform: uppercase;
            font-family: var(--font-main);
        }
        .btn-ring { background: var(--ring-orange); color: #000; } 
        .btn-win-game { background: var(--secondary-win); }
        .btn-lose-game { background: var(--loss-game); }
        .btn-win-leg { background: var(--secondary-leg); }
        .btn-lose-leg { background: var(--loss-leg); }
        
        .btn-undo-small { 
            background-color: var(--undo-color) !important; 
            color: #000000 !important;
            padding: 5px 15px; 
            font-size: 18px; 
            font-weight: bold;
            margin-left: 10px; 
        }
        
        .btn-pdf { 
            background: var(--pdf-btn-bg); 
            width: 100%; 
            margin-top: 15px; 
            padding: 18px; 
            font-size: 14px; 
            font-weight: 800;
        }

        .btn-stats {
            background: #444;
            color: #00c6ff;
            border: 1px solid #00c6ff;
            width: 100%;
            padding: 12px;
            margin-top: 10px;
        }

        .btn-delete-all {
            background: var(--delete-btn-bg);
            width: 100%;
            margin-top: 25px;
            padding: 10px;
            font-size: 11px;
            color: #ffcccc;
        }
        
        button:disabled { 
            background: #444 !important; 
            color: #666 !important; 
            opacity: 0.3; 
        }
        
        input {
            width: 100%; padding: 10px; margin-bottom: 8px; border-radius: 8px;
            border: 2px solid #444; background: var(--input-bg); color: #fff; box-sizing: border-box; font-size: 15px;
        }

        /* Styling für das Kalender-Icon (hellgrau) */
        #matchDate::-webkit-calendar-picker-indicator {
            filter: invert(0.7); /* Macht das Icon hellgrau */
            cursor: pointer;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #1a1a1a; padding: 8px; text-align: left; font-size: 0.65rem; color: var(--muted-text); text-transform: uppercase; }
        td { padding: 8px; border-bottom: 1px solid #333; font-size: 0.8rem; }
        .stats-val { font-weight: bold; color: #00c6ff; }
        .loss-val { color: #ff5252; font-weight: bold; }
        
        .setup-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; padding: 6px 10px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid var(--accent); font-size: 0.85rem;}
        .del-btn { background: #444; color: #ff5252; padding: 3px 8px; font-size: 10px; }
        .setting-label { font-size: 0.7rem; color: #777; margin-bottom: 4px; display: block; font-weight: 600; text-transform: uppercase; }

        .archive-item { cursor: pointer; border-bottom: 1px solid #333; }
        .archive-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; color: #00c6ff; font-weight: bold; }
        .archive-header::after { content: '▼'; font-size: 0.8rem; transition: transform 0.3s; }
        .archive-item.open .archive-header::after { transform: rotate(180deg); }
        .archive-content { display: none; padding-bottom: 10px; }
        .archive-item.open .archive-content { display: block; }

        .app-footer {
            width: 100%;
            text-align: center;
            padding: 20px 0;
            font-size: 0.7rem;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #statsOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .stats-content { max-width: 650px; margin: 40px auto; background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--accent); }
        .close-stats { background: var(--loss-matte); width: 100%; padding: 15px; margin-top: 20px; }
    </style>
</head>
<body>

<header class="app-header no-print">
    <h1>DartLog</h1>
</header>

<div class="container">
    <div class="card no-print">
        <div class="setup-container">
            <div>
                <label class="setting-label">Spieler hinzufügen</label>
                <input type="text" id="playerName" placeholder="Name...">
                <button class="btn-win-leg" style="width: 100%; margin-bottom: 15px;" onclick="addPlayer()">Hinzufügen</button>

                <label class="setting-label">Ring-Strafe (€)</label>
                <input type="number" id="penaltyAmount" value="0.20" step="0.05" onchange="updatePenaltyValue()">
            </div>
            <div>
                <label class="setting-label">Eingetragene Spieler</label>
                <div id="playerListEdit"></div>
            </div>
        </div>
    </div>

    <div id="playerActions" class="no-print"></div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h2 style="margin:0; font-family: var(--font-serif); font-style: italic; color: #00c6ff; font-size: 1.2rem;">Live-Score</h2>
            <input type="date" id="matchDate" class="no-print" style="width: auto; margin: 0; padding: 4px; font-size: 12px;">
        </div>
        
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr><th>Name</th><th>S</th><th>N</th><th>L+</th><th>L-</th><th>Kasse</th></tr>
                </thead>
                <tbody id="statsBody"></tbody>
            </table>
        </div>
        
        <button class="btn-win-leg no-print" style="width: 100%; margin-top: 15px; background: #2e7d32;" onclick="archiveDay()">Spieltag Archivieren & Reset</button>
    </div>

    <div id="archiveContainer"></div>

    <div class="card no-print" style="background: transparent; border: none; text-align: center; padding: 0;">
        <button class="btn-stats" onclick="showGlobalStats()">EWIGE BESTENLISTE ZEIGEN</button>
        <button class="btn-pdf" onclick="window.print()">PROTOKOLL ALS PDF SPEICHERN</button>
        <button class="btn-delete-all" onclick="hardReset()">KOMPLETTE APP ZURÜCKSETZEN</button>
    </div>
</div>

<footer class="app-footer no-print">
    DartLog v1.1.4 &bull; Entwickelt von Marcus Hörnemann
</footer>

<div id="statsOverlay" class="no-print">
    <div class="stats-content">
        <h2 style="font-family: var(--font-serif); font-style: italic; color: #00c6ff; text-align: center;">Ewige Bestenliste</h2>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr><th>Name</th><th>S</th><th>N</th><th>L +</th><th>L -</th><th>Kasse</th></tr>
                </thead>
                <tbody id="globalStatsBody"></tbody>
            </table>
        </div>
        <button class="close-stats" onclick="document.getElementById('statsOverlay').style.display='none'">SCHLIESSEN</button>
    </div>
</div>

<script>
    let players = JSON.parse(localStorage.getItem('dartPlayers')) || [];
    let archive = JSON.parse(localStorage.getItem('dartArchive')) || [];
    let currentPenalty = parseFloat(localStorage.getItem('dartPenalty')) || 0.20;
    let lastActions = {}; 

    document.getElementById('matchDate').valueAsDate = new Date();
    document.getElementById('penaltyAmount').value = currentPenalty.toFixed(2);

    function saveData() {
        localStorage.setItem('dartPlayers', JSON.stringify(players));
        localStorage.setItem('dartArchive', JSON.stringify(archive));
        localStorage.setItem('dartPenalty', currentPenalty);
        render();
    }

    function updatePenaltyValue() {
        currentPenalty = parseFloat(document.getElementById('penaltyAmount').value) || 0;
        saveData();
    }

    function addPlayer() {
        const name = document.getElementById('playerName').value.trim();
        if (!name) return;
        players.push({ name: name, games: 0, losses: 0, legsWin: 0, legsLoss: 0, penalty: 0 });
        document.getElementById('playerName').value = "";
        saveData();
    }

    function removePlayer(index) {
        if(confirm("Spieler löschen?")) { players.splice(index, 1); saveData(); }
    }

    function addStat(index, field) {
        lastActions[index] = field;
        if (field === 'penalty') players[index].penalty = Math.round((players[index].penalty + currentPenalty) * 100) / 100;
        else players[index][field] = (players[index][field] || 0) + 1;
        saveData();
    }

    function undo(index) {
        const f = lastActions[index];
        if (!f) return;
        if (f === 'penalty') players[index].penalty = Math.max(0, Math.round((players[index].penalty - currentPenalty) * 100) / 100);
        else players[index][f] = Math.max(0, players[index][f] - 1);
        lastActions[index] = null;
        saveData();
    }

    function archiveDay() {
        if(!confirm("Spieltag archivieren? Zähler werden auf 0 gesetzt.")) return;
        archive.unshift({ date: new Date(document.getElementById('matchDate').value).toLocaleDateString('de-DE'), data: JSON.parse(JSON.stringify(players)) });
        players.forEach(p => { p.games = 0; p.losses = 0; p.legsWin = 0; p.legsLoss = 0; p.penalty = 0; });
        lastActions = {};
        saveData();
    }

    function toggleArchive(index) {
        const item = document.getElementById(`archive-item-${index}`);
        item.classList.toggle('open');
    }

    function hardReset() { if (confirm("ACHTUNG: Alles löschen?")) { players = []; archive = []; saveData(); } }

    function showGlobalStats() {
        const stats = {};
        archive.forEach(day => {
            day.data.forEach(p => {
                if (!stats[p.name]) stats[p.name] = { wins: 0, losses: 0, legsWin: 0, legsLoss: 0, money: 0 };
                stats[p.name].wins += (p.games || 0);
                stats[p.name].losses += (p.losses || 0);
                stats[p.name].legsWin += (p.legsWin || 0);
                stats[p.name].legsLoss += (p.legsLoss || 0);
                stats[p.name].money += (p.penalty || 0);
            });
        });
        const sorted = Object.entries(stats).sort((a, b) => b[1].wins - a[1].wins);
        const body = document.getElementById('globalStatsBody');
        body.innerHTML = sorted.map(([name, d]) => `
            <tr>
                <td>${name}</td>
                <td class="stats-val">${d.wins}</td>
                <td class="loss-val">${d.losses}</td>
                <td>${d.legsWin}</td>
                <td style="color:#ff5252">${d.legsLoss}</td>
                <td style="color:#ffeb3b">${d.money.toFixed(2).replace('.', ',')} €</td>
            </tr>`).join('');
        document.getElementById('statsOverlay').style.display = 'block';
    }

    function render() {
        const actionDiv = document.getElementById('playerActions');
        const statsBody = document.getElementById('statsBody');
        const editList = document.getElementById('playerListEdit');
        actionDiv.innerHTML = ""; statsBody.innerHTML = ""; editList.innerHTML = "";

        players.forEach((p, index) => {
            editList.innerHTML += `<div class="setup-row"><span>${p.name}</span><button class="del-btn" onclick="removePlayer(${index})">X</button></div>`;
            const card = document.createElement('div');
            card.className = 'card player-row';
            card.innerHTML = `
                <div class="player-info">
                    <h3>${p.name}</h3>
                    <button class="btn-undo-small" onclick="undo(${index})" ${!lastActions[index] ? 'disabled' : ''}>&#10226;</button>
                </div>
                <div class="grid-row">
                    <button class="btn-win-game" onclick="addStat(${index}, 'games')">Sieg</button>
                    <button class="btn-lose-game" onclick="addStat(${index}, 'losses')">Lose</button>
                    <button class="btn-ring" onclick="addStat(${index}, 'penalty')">Ring</button>
                    <button class="btn-win-leg" onclick="addStat(${index}, 'legsWin')">Leg +</button>
                    <button class="btn-lose-leg" onclick="addStat(${index}, 'legsLoss')">Leg -</button>
                </div>`;
            actionDiv.appendChild(card);
            statsBody.innerHTML += `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.games}</td>
                    <td class="loss-val">${p.losses || 0}</td>
                    <td>${p.legsWin}</td>
                    <td>${p.legsLoss}</td>
                    <td class="stats-val">${p.penalty.toFixed(2).replace('.', ',')} €</td>
                </tr>`;
        });

        const archiveContainer = document.getElementById('archiveContainer');
        archiveContainer.innerHTML = archive.length ? `<h2 style="text-align:center; color:#555; font-size:1rem; margin-top:20px;">Archivierte Spieltage</h2>` : "";
        archive.forEach((e, i) => {
            let r = e.data.map(p => `<tr><td>${p.name}</td><td>${p.games}</td><td>${p.losses || 0}</td><td>${p.legsWin}</td><td>${p.legsLoss}</td><td>${p.penalty.toFixed(2).replace('.', ',')} €</td></tr>`).join('');
            archiveContainer.innerHTML += `
                <div class="card archive-item" id="archive-item-${i}" onclick="toggleArchive(${i})">
                    <div class="archive-header">Spieltag vom ${e.date}</div>
                    <div class="archive-content">
                        <table>
                            <thead><tr><th>Name</th><th>S</th><th>N</th><th>L+</th><th>L-</th><th>€</th></tr></thead>
                            <tbody>${r}</tbody>
                        </table>
                    </div>
                </div>`;
        });
    }
    render();
</script>
</body>
</html>
